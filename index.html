<!doctype html>
<html lang="zh-Hans">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>昆虫草木略：音注比较总览（点击联动明细）</title>
  <style>
    :root {
      --bg: #f7f8fb;
      --card: #fff;
      --text: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;

      --ok: #16a34a;
      --mid: #0ea5e9;
      --bad: #dc2626;

      --okbg: #eaffef;
      --midbg: #e8f7ff;
      --badbg: #ffecec;

      /* ✅ 新增：空格（空白） */
      --blank: #64748b;
      /* slate-500 */
      --blankbg: #f1f5f9;
      /* slate-100 */

      --mark: #ffe58f;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.55 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(247, 248, 251, .9);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--line);
    }

    .wrap {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      margin: 0 0 6px;
      font-size: 18px
    }

    .sub {
      color: var(--muted);
      font-size: 12px
    }

    .err {
      color: var(--bad);
      font-size: 12px;
      margin-top: 10px;
      display: none
    }

    .cards {
      display: grid;
      grid-template-columns: 1.3fr 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 12px
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: 0 2px 10px rgba(17, 24, 39, .04);
      padding: 12px;
      overflow: hidden;
    }

    .big {
      font-size: 22px;
      font-weight: 800;
      margin: 4px 0
    }

    .muted {
      color: var(--muted);
      font-size: 12px
    }

    /* ✅ 改：3 → 4 */
    .statGrid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px
    }

    .stat {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      cursor: pointer;
      user-select: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: transform .06s ease, box-shadow .06s ease;
    }

    .stat:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(17, 24, 39, .06)
    }

    .stat.ok {
      background: var(--okbg)
    }

    .stat.mid {
      background: var(--midbg)
    }

    .stat.bad {
      background: var(--badbg)
    }

    /* ✅ 新增：空格卡片 */
    .stat.blank {
      background: var(--blankbg)
    }

    .stat.active {
      outline: 3px solid rgba(17, 24, 39, .12)
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 800
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block
    }

    .dot.ok {
      background: var(--ok)
    }

    .dot.mid {
      background: var(--mid)
    }

    .dot.bad {
      background: var(--bad)
    }

    .dot.blank {
      background: var(--blank)
    }

    /* ✅ 新增 */

    .row2 {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 8px
    }

    .pill {
      border: 1px solid var(--line);
      background: #f1f5f9;
      border-radius: 999px;
      padding: 6px 10px;
      color: var(--muted);
      font-size: 12px;
    }

    .btn {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 700;
    }

    .tableCard {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: 0 2px 10px rgba(17, 24, 39, .04);
      overflow: hidden;
      margin-top: 12px;
    }

    .tableHead {
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .tableWrap {
      overflow: auto;
      max-height: 72vh
    }

    table {
      border-collapse: separate;
      border-spacing: 0;
      width: max-content;
      min-width: 100%
    }

    th,
    td {
      border-bottom: 1px solid var(--line);
      padding: 10px;
      vertical-align: top;
      white-space: pre-wrap;
      word-break: break-word
    }

    thead th {
      position: sticky;
      top: 0;
      background: #fff;
      border-bottom: 1px solid var(--line);
      text-align: left;
      font-size: 12px;
      color: var(--muted)
    }

    tr:hover td {
      background: #fafcff
    }

    td.state-ok {
      background: var(--okbg)
    }

    td.state-mid {
      background: var(--midbg)
    }

    td.state-bad {
      background: var(--badbg)
    }

    /* ✅ 新增：空格单元格上色 */
    td.state-blank {
      background: var(--blankbg)
    }

    mark {
      background: var(--mark);
      padding: 0 .15em;
      border-radius: 4px
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <h1>郑樵《通志·昆虫草木略》与《尔雅注》音注比较</h1>

      <div id="err" class="err"></div>

      <div class="cards">
        <div class="card">
          <div class="muted">总条目</div>
          <div class="big" id="totalN">-</div>
          <div class="muted"></div>
          <div class="row2">
            <span class="pill">当前视图：<b id="viewMode">全部</b></span>
            <button class="btn" id="showAllBtn">显示全部</button>
          </div>
        </div>

        <div class="card">
          <div class="muted">四种格子统计（点击）</div>
          <div class="statGrid">
            <div class="stat ok" id="statSame" data-state="same">
              <div class="tag"><span class="dot ok"></span>相同</div>
              <div class="big"><span id="sameN">-</span></div>
              <div class="muted">占比：<b id="sameP">-</b></div>
            </div>
            <div class="stat mid" id="statContain" data-state="contain">
              <div class="tag"><span class="dot mid"></span>包含</div>
              <div class="big"><span id="containN">-</span></div>
              <div class="muted">占比：<b id="containP">-</b></div>
            </div>
            <div class="stat bad" id="statDiff" data-state="diff">
              <div class="tag"><span class="dot bad"></span>不同</div>
              <div class="big"><span id="diffN">-</span></div>
              <div class="muted">占比：<b id="diffP">-</b></div>
            </div>

            <!-- ✅ 新增：空格 -->
            <div class="stat blank" id="statBlank" data-state="blank">
              <div class="tag"><span class="dot blank"></span>空格</div>
              <div class="big"><span id="blankN">-</span></div>
              <div class="muted">占比：<b id="blankP">-</b></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="muted">当前明细条数</div>
          <div class="big" id="detailN">-</div>
          <div class="muted">（随上方点击联动变化）</div>
        </div>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="tableCard">
      <div class="tableHead">
        <div>
          <b>明细表</b>
          <span class="muted">（点击上方“相同/包含/不同/空格”切换展示范围）</span>
        </div>
        <div class="pill"></div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:110px">被注音字</th>
              <th style="min-width:240px">昆蟲草木略</th>
              <th style="min-width:240px">爾雅注</th>
              <th style="min-width:110px">比对状态</th>
              <th style="min-width:120px">中華書局版頁碼</th>
              <th style="min-width:520px">昆蟲草木略原文</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const FILE = "昆虫草木略.json";
      const $ = (id) => document.getElementById(id);

      const state = {
        raw: [],
        rows: [],        // 加了 __state/__label 的全量
        view: "",        // "" | "same" | "contain" | "diff" | "blank"
      };

      function showErr(msg) {
        const el = $("err");
        el.style.display = msg ? "" : "none";
        el.textContent = msg || "";
      }

      function norm(s) {
        if (s === null || s === undefined) return "";
        return String(s).replace(/\s+/g, " ").trim();
      }

      function pct(n, total) {
        if (!total) return "0.00%";
        return (n * 100 / total).toFixed(2) + "%";
      }

      /* ✅ 改：新增 blank 逻辑
         规则：只要 A 或 B 任一侧为空（包括纯空白），就算“空格”
         若两边都为空，也归入“空格”（不再算“相同”）
      */
      function compare(a, b) {
        const A = norm(a);
        const B = norm(b);
        if (!A || !B) return { state: "blank", label: "空格" };
        if (A === B) return { state: "same", label: "相同" };
        if (A.includes(B) || B.includes(A)) return { state: "contain", label: "包含" };
        return { state: "diff", label: "不同" };
      }

      function escapeHTML(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function highlightNoteInOrig(orig, note) {
        const O = norm(orig);
        const N = norm(note);
        if (!O) return "";
        if (!N) return escapeHTML(O);
        const parts = O.split(N);
        if (parts.length === 1) return escapeHTML(O);
        const safeN = escapeHTML(N);
        return parts.map((p, i) => {
          const safeP = escapeHTML(p);
          if (i === parts.length - 1) return safeP;
          return safeP + `<mark><b>${safeN}</b></mark>`;
        }).join("");
      }

      function clsFor(st) {
        return st === "same"
          ? "state-ok"
          : st === "contain"
            ? "state-mid"
            : st === "diff"
              ? "state-bad"
              : "state-blank";
      }

      function setActiveCard(st) {
        $("statSame").classList.toggle("active", st === "same");
        $("statContain").classList.toggle("active", st === "contain");
        $("statDiff").classList.toggle("active", st === "diff");
        $("statBlank").classList.toggle("active", st === "blank");

        $("viewMode").textContent = st
          ? (st === "same" ? "相同"
            : st === "contain" ? "包含"
              : st === "diff" ? "不同"
                : "空格")
          : "全部";
      }

      function renderStats() {
        const total = state.rows.length;
        $("totalN").textContent = total;

        const same = state.rows.filter(r => r.__state === "same").length;
        const contain = state.rows.filter(r => r.__state === "contain").length;
        const diff = state.rows.filter(r => r.__state === "diff").length;
        const blank = state.rows.filter(r => r.__state === "blank").length;

        $("sameN").textContent = same;
        $("containN").textContent = contain;
        $("diffN").textContent = diff;
        $("blankN").textContent = blank;

        $("sameP").textContent = pct(same, total);
        $("containP").textContent = pct(contain, total);
        $("diffP").textContent = pct(diff, total);
        $("blankP").textContent = pct(blank, total);
      }

      function getViewRows() {
        if (!state.view) return state.rows;
        return state.rows.filter(r => r.__state === state.view);
      }

      function renderTable() {
        const tbody = $("tbody");
        tbody.innerHTML = "";

        const viewRows = getViewRows();
        $("detailN").textContent = viewRows.length;

        for (const r of viewRows) {
          const a = norm(r["昆蟲草木略"]);
          const b = norm(r["爾雅注"]);
          const orig = norm(r["昆蟲草木略原文"]);
          const c = clsFor(r.__state);

          const tr = document.createElement("tr");

          const tdZi = document.createElement("td");
          tdZi.textContent = norm(r["被注音字"]);

          const tdA = document.createElement("td");
          tdA.textContent = a;
          tdA.classList.add(c);

          const tdB = document.createElement("td");
          tdB.textContent = b;
          tdB.classList.add(c);

          const tdS = document.createElement("td");
          tdS.textContent = r.__label;
          tdS.classList.add(c);

          const tdO = document.createElement("td");
          tdO.textContent = norm(r["中華書局版頁碼"]);

          const tdP = document.createElement("td");
          tdP.innerHTML = highlightNoteInOrig(orig, a);

          tr.appendChild(tdZi);
          tr.appendChild(tdA);
          tr.appendChild(tdB);
          tr.appendChild(tdS);
          tr.appendChild(tdO);
          tr.appendChild(tdP);

          tbody.appendChild(tr);
        }
      }

      function setView(st) {
        state.view = st; // "" | same | contain | diff | blank
        setActiveCard(st);
        renderTable();
      }

      async function init() {
        try {
          showErr("");
          const res = await fetch(FILE, { cache: "no-store" });
          if (!res.ok) throw new Error(`无法读取 ${FILE}（HTTP ${res.status}）`);
          const data = await res.json();
          if (!Array.isArray(data)) throw new Error("JSON 顶层不是数组（[]）");

          state.raw = data;
          state.rows = data.map(r => {
            const c = compare(r?.["昆蟲草木略"], r?.["爾雅注"]);
            return { ...r, __state: c.state, __label: c.label };
          });

          renderStats();
          setView(""); // 默认全部
        } catch (e) {
          showErr(e?.message || String(e));
          console.error(e);
        }
      }

      function toggleCard(st) {
        if (state.view === st) setView("");
        else setView(st);
      }

      $("statSame").addEventListener("click", () => toggleCard("same"));
      $("statContain").addEventListener("click", () => toggleCard("contain"));
      $("statDiff").addEventListener("click", () => toggleCard("diff"));
      $("statBlank").addEventListener("click", () => toggleCard("blank"));
      $("showAllBtn").addEventListener("click", () => setView(""));

      init();
    })();
  </script>
</body>

</html>